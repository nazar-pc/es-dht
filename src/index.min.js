/*
 0BSD
*/
(function(){function y(k,r){var h;if(k===r)return!0;if(k.length!==r.length)return!1;var c=0;for(h=k.length;c<h;++c){var g=c;var n=k[c];if(n!==r[g])return!1}return!0}function t(k,r,h){function c(a){if(!(this instanceof c))return new c(a);this.c=a;this.a=n();this.b=null}function g(a,b,d,f,e){null==e&&(e=.2);if(!(this instanceof g))return new g(a,b,d,f,e);this.b=a;this.v=a.length;this.i=b;this.s=d;this.u=e;this.g=c(f);this.c=r(this.b,d);this.f=n();this.j(new Map)}var n=k.ArrayMap;var t=k.ArraySet;c.prototype=
{add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.b=a,this.a.size>this.c))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)},h:function(a){var b;this.a["delete"](a);this.a.has(this.b)||(this.b=(b=Array.from(this.a.keys()))[b.length-1]||null)}};Object.defineProperty(c.prototype,"constructor",{value:c});g.prototype={start_lookup:function(a,b){var d,f,e;null==b&&(b=this.s);if(this.c.has(a))return[];var u=r(a,b);var c=n();var m=this.a();m.forEach(function(a,
b){var d;a=a[1];u.set(b);var f=0;for(d=a.length;f<d;++f){var e=a[f];!c.has(e)&&u.set(e)&&c.set(e,b)}});for(d=Math.max(this.u,1/this.c.size);;){var g=u.closest(a,b);var l=g.length;l=Math.ceil(l*d);var k=[];var h=t();var v=n();var w=!1;var x=0;for(f=g.length;x<f;++x){var p=g[x];if(e=c.get(p)){var q=v.get(e)||0;v.set(e,q+1);q>l?(u.h(p),w=!0):(q=m.get(e),k.push([p,e,q]),h.add(p))}else q=v.get(p)||0,v.set(p,q+1),q>l&&(u.h(p),w=!0)}if(!w)break}this.f.set(a,[h,u,b]);return k},update_lookup:function(a,b,
d,f){var e;var c=this.f.get(a);if(!c)return[];var g=c[0];var m=c[1];var k=c[2];g["delete"](b);if(!f)return m.h(b),[];c=t();var l=0;for(e=f.length;l<e;++l){var h=f[l];!m.has(h)&&m.set(h)&&c.add(h)}a=m.closest(a,k);f=[];l=0;for(e=a.length;l<e;++l)m=a[l],c.has(m)&&(f.push([m,b,d]),g.add(m));return f},finish_lookup:function(a){var b=this.f.get(a);this.f["delete"](a);return this.c.has(a)?[a]:b?b[1].closest(a,b[2]):null},set_peer:function(a,b,d,c){d=this.l(b,d,a);if(!d||!y(d,a)||!this.c.set(a))return!1;
d=this.m();d.set(a,[b,c]);this.j(d);return!0},del_peer:function(a){var b=this.m();b.has(a)&&(this.c["delete"](a),b["delete"](a),this.j(b))},get_state:function(a){null==a&&(a=null);a=a||this.g.b;var b=this.a(a);if(!b)return null;var d=this.get_state_proof(a,this.b);return[a,d,Array.from(b.keys())]},a:function(a){null==a&&(a=null);return(a=a||this.g.b)?this.g.get(a):null},m:function(a){null==a&&(a=null);return(a=this.a(a))?n(Array.from(a)):null},get_state_proof:function(a,b){return(a=this.a(a))&&(a.has(b)||
y(b,this.b))?(a=this.o(a),h.get_proof(a,b,this.i)):new Uint8Array(0)},o:function(a){var b=[];a.forEach(function(a,c){b.push(c,a[0])});b.push(this.b,this.b);return b},check_state_proof:function(a,b,c,f){a=this.a(a);if(!a)return null;b=a.get(b)[0];return this.l(b,c,f)},l:function(a,b,c){return 0===b[0]&&h.check_proof(a,b,c,this.i)?b.subarray(1,this.v+1):null},j:function(a){var b=this.o(a);b=h.get_root(b,this.i);this.g.add(b,a)}};Object.defineProperty(g.prototype,"constructor",{value:g});return g}"function"===
typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],t):"object"===typeof exports?module.exports=t(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.detox_transport=t(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);