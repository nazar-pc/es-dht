/*
 0BSD
*/
(function(){function n(d,p){var l;if(d===p)return!0;if(d.length!==p.length)return!1;var c=0;for(l=d.length;c<l;++c){var k=c;var q=d[c];if(q!==p[k])return!1}return!0}function y(d,p){var l=d.length;var c=new Uint8Array(2*l);c.set(d);c.set(p,l);return c}function u(d,p,l){function c(a){if(!(this instanceof c))return new c(a);this.c=a;this.a=q();this.b=null}function k(a,b,g,v,e){null==e&&(e=.2);if(!(this instanceof k))return new k(a,b,g,v,e);this.a=a;this.l=a.length;this.f=b;this.o=g;this.s=e;this.h=c(v);
this.b=p(this.a,g);this.g=q();this.i(new Map)}var q=d.ArrayMap;var u=d.ArraySet;c.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.b=a,this.a.size>this.c))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)}};Object.defineProperty(c.prototype,"constructor",{value:c});k.prototype={start_lookup:function(a,b){var g,v,e;null==b&&(b=this.o);if(this.b.has(a))return[];var h=p(a,b);var c=q();var f=this.c();f.forEach(function(a,b){var g;a=a[1];h.set(b);var e=
0;for(g=a.length;e<g;++e){var f=a[e];!c.has(f)&&h.set(f)&&c.set(f,b)}});h.del(this.a);for(g=Math.max(this.s,1/this.b.count());;){var d=h.closest(a,b);var m=d.length;m=Math.ceil(m*g);var l=[];var k=u();var n=q();var w=!1;var x=0;for(v=d.length;x<v;++x){var r=d[x];if(e=c.get(r)){var t=n.get(e)||0;n.set(e,t+1);t>m?(h.del(r),w=!0):(t=f.get(e)[0],l.push([r,e,t]),k.add(r))}else t=n.get(r)||0,n.set(r,t+1),t>m&&(h.del(r),w=!0)}if(!w)break}this.g.set(a,[k,h,b]);return l},update_lookup:function(a,b,g,c){var e;
var h=this.g.get(a);if(!h)return[];var d=h[0];var f=h[1];var l=h[2];d["delete"](b);if(!c)return f.del(b),[];h=u();var m=0;for(e=c.length;m<e;++m){var k=c[m];!f.has(k)&&f.set(k)&&h.add(k)}f.del(this.a);a=f.closest(a,l);c=[];m=0;for(e=a.length;m<e;++m)f=a[m],h.has(f)&&(c.push([f,b,g]),d.add(f));return c},finish_lookup:function(a){var b=this.g.get(a);this.g["delete"](a);return this.b.has(a)?[a]:b?b[1].closest(a,b[2]):null},set_peer:function(a,b,g,c){if(n(this.a,a))return!1;var e=2*c.length+2;var h=this.l+
1;var d=Math.log2(e);var f=g.length/h;if(f!==d){if(f!==Math.ceil(d))return!1;d=a;f=0;for(e=Math.ceil(Math.pow(Math.log2(e),2)-e)/2;f<=e;++f){var k=f;if(0!==g[k*h]||!n(g.subarray(k*h+1,(k+1)*h),d))return!1;d=this.f(y(d,d))}}g=this.check_state_proof(b,g,a);if(!g||!n(g,a))return!1;if(!this.b.set(a))return!0;g=this.j();g.set(a,[b,c]);this.i(g);return!0},has_peer:function(a){return this.b.has(a)},del_peer:function(a){var b=this.j();b.has(a)&&(this.b.del(a),b["delete"](a),this.i(b))},get_state:function(a){null==
a&&(a=null);a=a||this.h.b;var b=this.c(a);if(!b)return null;var c=this.get_state_proof(a,this.a);return[a,c,Array.from(b.keys())]},c:function(a){null==a&&(a=null);return(a=a||this.h.b)?this.h.get(a):null},j:function(a){null==a&&(a=null);return(a=this.c(a))?q(Array.from(a)):null},get_state_proof:function(a,b){return(a=this.c(a))&&(a.has(b)||n(b,this.a))?(a=this.m(a),l.get_proof(a,b,this.f)):new Uint8Array(0)},m:function(a){var b=[];a.forEach(function(a,c){b.push(c,a[0])});b.push(this.a,this.a);return b},
check_state_proof:function(a,b,c){return 0===b[0]&&l.check_proof(a,b,c,this.f)?b.subarray(1,this.l+1):null},i:function(a){var b=this.m(a);b=l.get_root(b,this.f);this.h.add(b,a)}};Object.defineProperty(k.prototype,"constructor",{value:k});return k}"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],u):"object"===typeof exports?module.exports=u(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.es_dht=u(this.array_map_set,
this.k_bucket_sync,this.merkle_tree_binary)}).call(this);