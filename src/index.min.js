/*
 0BSD
*/
(function(){function p(d,n){var l;if(d===n)return!0;if(d.length!==n.length)return!1;var c=0;for(l=d.length;c<l;++c){var h=c;var q=d[c];if(q!==n[h])return!1}return!0}function y(d,n){var l=d.length;var c=new Uint8Array(2*l);c.set(d);c.set(n,l);return c}function u(d,n,l){function c(a){if(!(this instanceof c))return new c(a);this.c=a;this.a=q();this.b=null}function h(a,b,f,g,e){null==e&&(e=.2);if(!(this instanceof h))return new h(a,b,f,g,e);this.c=a;this.o=a.length;this.f=b;this.u=f;this.v=e;this.h=c(g);
this.a=n(this.c,f);this.g=q();this.j(new Map)}var q=d.ArrayMap;var u=d.ArraySet;c.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.b=a,this.a.size>this.c))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)},i:function(a){var b;this.a["delete"](a);this.a.has(this.b)||(this.b=(b=Array.from(this.a.keys()))[b.length-1]||null)}};Object.defineProperty(c.prototype,"constructor",{value:c});h.prototype={start_lookup:function(a,b){var f,g,e;null==b&&(b=this.u);
if(this.a.has(a))return[];var v=n(a,b);var c=q();var k=this.b();k.forEach(function(a,b){var f;a=a[1];v.set(b);var e=0;for(f=a.length;e<f;++e){var g=a[e];!c.has(g)&&v.set(g)&&c.set(g,b)}});for(f=Math.max(this.v,1/this.a.count());;){var d=v.closest(a,b);var m=d.length;m=Math.ceil(m*f);var l=[];var h=u();var w=q();var p=!1;var x=0;for(g=d.length;x<g;++x){var r=d[x];if(e=c.get(r)){var t=w.get(e)||0;w.set(e,t+1);t>m?(v.i(r),p=!0):(t=k.get(e),l.push([r,e,t]),h.add(r))}else t=w.get(r)||0,w.set(r,t+1),t>
m&&(v.i(r),p=!0)}if(!p)break}this.g.set(a,[h,v,b]);return l},update_lookup:function(a,b,f,g){var e;var c=this.g.get(a);if(!c)return[];var d=c[0];var k=c[1];var l=c[2];d["delete"](b);if(!g)return k.i(b),[];c=u();var m=0;for(e=g.length;m<e;++m){var h=g[m];!k.has(h)&&k.set(h)&&c.add(h)}a=k.closest(a,l);g=[];m=0;for(e=a.length;m<e;++m)k=a[m],c.has(k)&&(g.push([k,b,f]),d.add(k));return g},finish_lookup:function(a){var b=this.g.get(a);this.g["delete"](a);return this.a.has(a)?[a]:b?b[1].closest(a,b[2]):
null},set_peer:function(a,b,f,c){var e=2*c.length+2;var g=this.o+1;var d=Math.log2(e);var k=f.length/g;if(k!==d){if(k!==Math.ceil(d))return!1;d=a;k=0;for(e=Math.ceil(Math.pow(Math.log2(e),2)-e)/2;k<=e;++k){var h=k;if(0!==f[h*g]||!p(f.subarray(h*g+1,(h+1)*g),d))return!1;d=this.f(y(d,d))}}f=this.l(b,f,a);if(!f||!p(f,a))return!1;if(!this.a.set(a))return!0;f=this.m();f.set(a,[b,c]);this.j(f);return!0},has_peer:function(a){return this.a.has(a)},del_peer:function(a){var b=this.m();b.has(a)&&(this.a["delete"](a),
b["delete"](a),this.j(b))},get_state:function(a){null==a&&(a=null);a=a||this.h.b;var b=this.b(a);if(!b)return null;var c=this.get_state_proof(a,this.c);return[a,c,Array.from(b.keys())]},b:function(a){null==a&&(a=null);return(a=a||this.h.b)?this.h.get(a):null},m:function(a){null==a&&(a=null);return(a=this.b(a))?q(Array.from(a)):null},get_state_proof:function(a,b){return(a=this.b(a))&&(a.has(b)||p(b,this.c))?(a=this.s(a),l.get_proof(a,b,this.f)):new Uint8Array(0)},s:function(a){var b=[];a.forEach(function(a,
c){b.push(c,a[0])});b.push(this.c,this.c);return b},check_state_proof:function(a,b,c,d){a=this.b(a);if(!a)return null;b=a.get(b)[0];return this.l(b,c,d)},l:function(a,b,c){return 0===b[0]&&l.check_proof(a,b,c,this.f)?b.subarray(1,this.o+1):null},j:function(a){var b=this.s(a);b=l.get_root(b,this.f);this.h.add(b,a)}};Object.defineProperty(h.prototype,"constructor",{value:h});return h}"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],u):"object"===typeof exports?
module.exports=u(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.es_dht=u(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);