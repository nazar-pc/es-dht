/*
 0BSD
*/
(function(){function p(d,n){var l;if(d===n)return!0;if(d.length!==n.length)return!1;var c=0;for(l=d.length;c<l;++c){var h=c;var q=d[c];if(q!==n[h])return!1}return!0}function y(d,n){var l=d.length;var c=new Uint8Array(2*l);c.set(d);c.set(n,l);return c}function u(d,n,l){function c(a){if(!(this instanceof c))return new c(a);this.c=a;this.a=q();this.b=null}function h(a,b,f,v,e){null==e&&(e=.2);if(!(this instanceof h))return new h(a,b,f,v,e);this.b=a;this.m=a.length;this.f=b;this.s=f;this.u=e;this.h=c(v);
this.a=n(this.b,f);this.g=q();this.j(new Map)}var q=d.ArrayMap;var u=d.ArraySet;c.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.b=a,this.a.size>this.c))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)},i:function(a){var b;this.a["delete"](a);this.a.has(this.b)||(this.b=(b=Array.from(this.a.keys()))[b.length-1]||null)}};Object.defineProperty(c.prototype,"constructor",{value:c});h.prototype={start_lookup:function(a,b){var f,v,e;null==b&&(b=this.s);
if(this.a.has(a))return[];var k=n(a,b);var c=q();var g=this.c();g.forEach(function(a,b){var f;a=a[1];k.set(b);var e=0;for(f=a.length;e<f;++e){var g=a[e];!c.has(g)&&k.set(g)&&c.set(g,b)}});for(f=Math.max(this.u,1/this.a.count());;){var d=k.closest(a,b);var m=d.length;m=Math.ceil(m*f);var l=[];var h=u();var w=q();var p=!1;var x=0;for(v=d.length;x<v;++x){var r=d[x];if(e=c.get(r)){var t=w.get(e)||0;w.set(e,t+1);t>m?(k.i(r),p=!0):(t=g.get(e)[0],l.push([r,e,t]),h.add(r))}else t=w.get(r)||0,w.set(r,t+1),
t>m&&(k.i(r),p=!0)}if(!p)break}this.g.set(a,[h,k,b]);return l},update_lookup:function(a,b,f,c){var e;var k=this.g.get(a);if(!k)return[];var d=k[0];var g=k[1];var l=k[2];d["delete"](b);if(!c)return g.i(b),[];k=u();var m=0;for(e=c.length;m<e;++m){var h=c[m];!g.has(h)&&g.set(h)&&k.add(h)}a=g.closest(a,l);c=[];m=0;for(e=a.length;m<e;++m)g=a[m],k.has(g)&&(c.push([g,b,f]),d.add(g));return c},finish_lookup:function(a){var b=this.g.get(a);this.g["delete"](a);return this.a.has(a)?[a]:b?b[1].closest(a,b[2]):
null},set_peer:function(a,b,f,c){var e=2*c.length+2;var k=this.m+1;var d=Math.log2(e);var g=f.length/k;if(g!==d){if(g!==Math.ceil(d))return!1;d=a;g=0;for(e=Math.ceil(Math.pow(Math.log2(e),2)-e)/2;g<=e;++g){var h=g;if(0!==f[h*k]||!p(f.subarray(h*k+1,(h+1)*k),d))return!1;d=this.f(y(d,d))}}f=this.check_state_proof(b,f,a);if(!f||!p(f,a))return!1;if(!this.a.set(a))return!0;f=this.l();f.set(a,[b,c]);this.j(f);return!0},has_peer:function(a){return this.a.has(a)},del_peer:function(a){var b=this.l();b.has(a)&&
(this.a["delete"](a),b["delete"](a),this.j(b))},get_state:function(a){null==a&&(a=null);a=a||this.h.b;var b=this.c(a);if(!b)return null;var c=this.get_state_proof(a,this.b);return[a,c,Array.from(b.keys())]},c:function(a){null==a&&(a=null);return(a=a||this.h.b)?this.h.get(a):null},l:function(a){null==a&&(a=null);return(a=this.c(a))?q(Array.from(a)):null},get_state_proof:function(a,b){return(a=this.c(a))&&(a.has(b)||p(b,this.b))?(a=this.o(a),l.get_proof(a,b,this.f)):new Uint8Array(0)},o:function(a){var b=
[];a.forEach(function(a,c){b.push(c,a[0])});b.push(this.b,this.b);return b},check_state_proof:function(a,b,c){return 0===b[0]&&l.check_proof(a,b,c,this.f)?b.subarray(1,this.m+1):null},j:function(a){var b=this.o(a);b=l.get_root(b,this.f);this.h.add(b,a)}};Object.defineProperty(h.prototype,"constructor",{value:h});return h}"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],u):"object"===typeof exports?module.exports=u(require("array-map-set"),require("k-bucket-sync"),
require("merkle-tree-binary")):this.es_dht=u(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);