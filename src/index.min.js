/*
 0BSD
*/
(function(){function n(h,q){var k;if(h===q)return!0;if(h.length!==q.length)return!1;var d=0;for(k=h.length;d<k;++d){var m=d;var r=h[d];if(r!==q[m])return!1}return!0}function y(h,q){var k=h.length;var d=new Uint8Array(2*k);d.set(h);d.set(q,k);return d}function t(h,q,k){function d(a){if(!(this instanceof d))return new d(a);this.b=a;this.a=r()}function m(a,b,c,l,g){null==g&&(g=.2);if(!(this instanceof m))return new m(a,b,c,l,g);this.a=a;this.l=a.length;this.f=b;this.s=c;this.u=g;this.o=d(l);this.g=[];
this.b=q(this.a,c);this.h=r();this.i(new Map)}var r=h.ArrayMap;var t=h.ArraySet;d.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.a.size>this.b))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)}};Object.defineProperty(d.prototype,"constructor",{value:d});m.prototype={start_lookup:function(a,b){var c,l;null==b&&(b=this.s);if(this.b.has(a))return[];var g=q(a,b);var v=r();var e=this.c()[1];var d=t();e.forEach(function(a,b){var c;a=a[1];d.add(b);
g.set(b);var e=0;for(c=a.length;e<c;++e){var f=a[e];!v.has(f)&&g.set(f)&&v.set(f,b)}});if(g.has(a)){var f=v.get(a);var p=e.get(f)[0];var h=[[a,f,p]]}else for(g.del(this.a),c=Math.max(this.u,1/this.b.count());;){var k=g.closest(a,b);f=k.length;var m=Math.ceil(f*c);h=[];var n=r();var w=!1;var x=0;for(l=k.length;x<l;++x){var u=k[x];(f=v.get(u))?(p=n.get(f)||0,n.set(f,p+1),p>m?(g.del(u),w=!0):(p=e.get(f)[0],h.push([u,f,p]))):(p=n.get(u)||0,n.set(u,p+1),p>m&&(g.del(u),w=!0))}if(!w)break}this.h.set(a,[g,
b,d]);return h},update_lookup:function(a,b,c,l){var g;var d=this.h.get(a);if(!d)return[];var e=d[0];var h=d[1];d[2].add(b);if(this.b.has(a)||e.has(a))return[];if(!l)return e.del(b),[];d=t();var f=0;for(g=l.length;f<g;++f){var k=l[f];!e.has(k)&&e.set(k)&&d.add(k)}if(e.has(a))return[[a,b,c]];e.del(this.a);a=e.closest(a,h);l=[];f=0;for(g=a.length;f<g;++f)e=a[f],d.has(e)&&l.push([e,b,c]);return l},finish_lookup:function(a){var b=this.h.get(a);this.h["delete"](a);if(!b)return null;var c=b[0];var d=b[1];
b=b[2];return this.b.has(a)||b.has(a)?[a]:c.closest(a,d)},set_peer:function(a,b,c,d){if(n(this.a,a))return!1;var g=2*d.length+2;var k=this.l+1;var e=Math.log2(g);var h=c.length/k;if(h!==e){if(h!==Math.ceil(e))return!1;e=a;h=0;for(g=Math.ceil(Math.pow(Math.log2(g),2)-g)/2;h<=g;++h){var f=h;if(0!==c[f*k]||!n(c.subarray(f*k+1,(f+1)*k),e))return!1;e=this.f(y(e,e))}}c=this.check_state_proof(b,c,a);if(!c||!n(c,a))return!1;if(!this.b.set(a))return!0;c=this.j();c.set(a,[b,d]);this.i(c);return!0},has_peer:function(a){return this.b.has(a)},
del_peer:function(a){var b=this.j();b.has(a)&&(this.b.del(a),b["delete"](a),this.i(b))},get_state:function(a){null==a&&(a=null);var b=this.c(a);if(!b)return null;a=b[0];b=b[1];var c=this.get_state_proof(a,this.a);return[a,c,Array.from(b.keys())]},commit_state:function(){var a=this.g;this.o.add(a[0],a[1])},c:function(a){var b;null==a&&(a=null);return!a||n(a,this.g[0])?this.g:(b=this.o.get(a))?[a,b]:null},j:function(a){var b;null==a&&(a=null);return(a=null!=(b=this.c(a))?b[1]:void 0)?r(Array.from(a)):
null},get_state_proof:function(a,b){var c;return(a=null!=(c=this.c(a))?c[1]:void 0)&&(a.has(b)||n(b,this.a))?(c=this.m(a),k.get_proof(c,b,this.f)):new Uint8Array(0)},m:function(a){var b=[];a.forEach(function(a,d){b.push(d,a[0])});b.push(this.a,this.a);return b},check_state_proof:function(a,b,c){return 0===b[0]&&k.check_proof(a,b,c,this.f)?b.subarray(1,this.l+1):null},i:function(a){var b=this.m(a);this.g=[k.get_root(b,this.f),a]}};Object.defineProperty(m.prototype,"constructor",{value:m});return m}
"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],t):"object"===typeof exports?module.exports=t(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.es_dht=t(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);