/*
 0BSD
*/
(function(){function p(d,r){var l;if(d===r)return!0;if(d.length!==r.length)return!1;var f=0;for(l=d.length;f<l;++f){var n=f;var t=d[f];if(t!==r[n])return!1}return!0}function y(d,r){var l=d.length;var f=new Uint8Array(2*l);f.set(d);f.set(r,l);return f}function u(d,r,l){function f(a){if(!(this instanceof f))return new f(a);this.b=a;this.a=t()}function n(a,b,c,m,h){null==h&&(h=.2);if(!(this instanceof n))return new n(a,b,c,m,h);this.a=a;this.l=a.length;this.f=b;this.s=c;this.u=h;this.o=f(m);this.g=[];
this.b=r(this.a,c);this.h=t();this.i(new Map)}var t=d.ArrayMap;var u=d.ArraySet;f.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.a.size>this.b))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)}};Object.defineProperty(f.prototype,"constructor",{value:f});n.prototype={start_lookup:function(a,b){var c,m;null==b&&(b=this.s);if(this.b.has(a))return[];var h=r(a,b);var k=t();var e=this.c()[1];var f=u();e.forEach(function(a,b){var c;a=a[1];f.add(b);
h.set(b);var e=0;for(c=a.length;e<c;++e){var g=a[e];!k.has(g)&&h.set(g)&&k.set(g,b)}});if(h.has(a)){var g=k.get(a);var q=e.get(g)[0];var d=[[a,g,q]]}else for(h.del(this.a),c=Math.max(this.u,1/this.b.count());;){var l=h.closest(a,b);g=l.length;var n=Math.ceil(g*c);d=[];var p=t();var w=!1;var x=0;for(m=l.length;x<m;++x){var v=l[x];(g=k.get(v))?(q=p.get(g)||0,p.set(g,q+1),q>n?(h.del(v),w=!0):(q=e.get(g)[0],d.push([v,g,q]))):(q=p.get(v)||0,p.set(v,q+1),q>n&&(h.del(v),w=!0))}if(!w)break}this.h.set(a,[h,
b,f]);return d},update_lookup:function(a,b,c,m){var h;var k=this.h.get(a);if(!k)return[];var e=k[0];var f=k[1];k=k[2];if(!m)return e.del(b),[];k.add(b);if(this.b.has(a)||e.has(a))return[];k=u();var g=0;for(h=m.length;g<h;++g){var d=m[g];!e.has(d)&&e.set(d)&&k.add(d)}if(e.has(a))return[[a,b,c]];e.del(this.a);a=e.closest(a,f);m=[];g=0;for(h=a.length;g<h;++g)e=a[g],k.has(e)&&m.push([e,b,c]);return m},finish_lookup:function(a){var b=this.h.get(a);this.h["delete"](a);if(!b)return null;var c=b[0];var f=
b[1];b=b[2];return this.b.has(a)||b.has(a)?[a]:c.closest(a,f)},set_peer:function(a,b,c,f){if(p(this.a,a))return!1;var h=2*f.length+2;var k=this.l+1;var e=Math.log2(h);var d=c.length/k;if(d!==e){if(d!==Math.ceil(e))return!1;e=a;d=0;for(h=Math.ceil(Math.pow(Math.log2(h),2)-h)/2;d<=h;++d){var g=d;if(0!==c[g*k]||!p(c.subarray(g*k+1,(g+1)*k),e))return!1;e=this.f(y(e,e))}}c=this.check_state_proof(b,c,a);if(!c||!p(c,a))return!1;if(!this.b.set(a))return!0;c=this.j();c.set(a,[b,f]);this.i(c);return!0},has_peer:function(a){return this.b.has(a)},
del_peer:function(a){var b=this.j();b.has(a)&&(this.b.del(a),b["delete"](a),this.i(b))},get_state:function(a){null==a&&(a=null);var b=this.c(a);if(!b)return null;a=b[0];b=b[1];var c=this.get_state_proof(a,this.a);return[a,c,Array.from(b.keys())]},commit_state:function(){var a=this.g;this.o.add(a[0],a[1])},c:function(a){var b;null==a&&(a=null);return!a||p(a,this.g[0])?this.g:(b=this.o.get(a))?[a,b]:null},j:function(a){var b;null==a&&(a=null);return(a=null!=(b=this.c(a))?b[1]:void 0)?t(Array.from(a)):
null},get_state_proof:function(a,b){var c;return(a=null!=(c=this.c(a))?c[1]:void 0)&&(a.has(b)||p(b,this.a))?(c=this.m(a),l.get_proof(c,b,this.f)):new Uint8Array(0)},m:function(a){var b=[];a.forEach(function(a,d){b.push(d,a[0])});b.push(this.a,this.a);return b},check_state_proof:function(a,b,c){return 0===b[0]&&l.check_proof(a,b,c,this.f)?b.subarray(1,this.l+1):null},i:function(a){var b=this.m(a);this.g=[l.get_root(b,this.f),a]}};Object.defineProperty(n.prototype,"constructor",{value:n});return n}
"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],u):"object"===typeof exports?module.exports=u(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.es_dht=u(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);