/*
 0BSD
*/
(function(){function n(e,p){var l;if(e===p)return!0;if(e.length!==p.length)return!1;var c=0;for(l=e.length;c<l;++c){var k=c;var q=e[c];if(q!==p[k])return!1}return!0}function y(e,p){var l=e.length;var c=new Uint8Array(2*l);c.set(e);c.set(p,l);return c}function u(e,p,l){function c(a){if(!(this instanceof c))return new c(a);this.b=a;this.a=q()}function k(a,b,d,v,f){null==f&&(f=.2);if(!(this instanceof k))return new k(a,b,d,v,f);this.a=a;this.l=a.length;this.f=b;this.s=d;this.u=f;this.o=c(v);this.g=[];
this.b=p(this.a,d);this.h=q();this.i(new Map)}var q=e.ArrayMap;var u=e.ArraySet;c.prototype={add:function(a,b){if(!this.a.has(a)&&(this.a.set(a,b),this.a.size>this.b))this.a["delete"](this.a.keys().next().value)},get:function(a){return this.a.get(a)}};Object.defineProperty(c.prototype,"constructor",{value:c});k.prototype={start_lookup:function(a,b){var d,v,f;null==b&&(b=this.s);if(this.b.has(a))return[];var h=p(a,b);var c=q();var g=this.c()[1];g.forEach(function(a,b){var d;a=a[1];h.set(b);var f=0;
for(d=a.length;f<d;++f){var g=a[f];!c.has(g)&&h.set(g)&&c.set(g,b)}});h.del(this.a);for(d=Math.max(this.u,1/this.b.count());;){var e=h.closest(a,b);var m=e.length;m=Math.ceil(m*d);var l=[];var k=u();var n=q();var w=!1;var x=0;for(v=e.length;x<v;++x){var r=e[x];if(f=c.get(r)){var t=n.get(f)||0;n.set(f,t+1);t>m?(h.del(r),w=!0):(t=g.get(f)[0],l.push([r,f,t]),k.add(r))}else t=n.get(r)||0,n.set(r,t+1),t>m&&(h.del(r),w=!0)}if(!w)break}this.h.set(a,[k,h,b]);return l},update_lookup:function(a,b,d,c){var f;
var h=this.h.get(a);if(!h)return[];var e=h[0];var g=h[1];var l=h[2];e["delete"](b);if(!c)return g.del(b),[];h=u();var m=0;for(f=c.length;m<f;++m){var k=c[m];!g.has(k)&&g.set(k)&&h.add(k)}g.del(this.a);a=g.closest(a,l);c=[];m=0;for(f=a.length;m<f;++m)g=a[m],h.has(g)&&(c.push([g,b,d]),e.add(g));return c},finish_lookup:function(a){var b=this.h.get(a);this.h["delete"](a);return this.b.has(a)?[a]:b?b[1].closest(a,b[2]):null},set_peer:function(a,b,d,c){if(n(this.a,a))return!1;var f=2*c.length+2;var h=this.l+
1;var e=Math.log2(f);var g=d.length/h;if(g!==e){if(g!==Math.ceil(e))return!1;e=a;g=0;for(f=Math.ceil(Math.pow(Math.log2(f),2)-f)/2;g<=f;++g){var k=g;if(0!==d[k*h]||!n(d.subarray(k*h+1,(k+1)*h),e))return!1;e=this.f(y(e,e))}}d=this.check_state_proof(b,d,a);if(!d||!n(d,a))return!1;if(!this.b.set(a))return!0;d=this.j();d.set(a,[b,c]);this.i(d);return!0},has_peer:function(a){return this.b.has(a)},del_peer:function(a){var b=this.j();b.has(a)&&(this.b.del(a),b["delete"](a),this.i(b))},get_state:function(a){null==
a&&(a=null);var b=this.c(a);if(!b)return null;a=b[0];b=b[1];var d=this.get_state_proof(a,this.a);return[a,d,Array.from(b.keys())]},commit_state:function(){var a=this.g;this.o.add(a[0],a[1])},c:function(a){var b;null==a&&(a=null);return!a||n(a,this.g[0])?this.g:(b=this.o.get(a))?[a,b]:null},j:function(a){var b;null==a&&(a=null);return(a=null!=(b=this.c(a))?b[1]:void 0)?q(Array.from(a)):null},get_state_proof:function(a,b){var d;return(a=null!=(d=this.c(a))?d[1]:void 0)&&(a.has(b)||n(b,this.a))?(d=this.m(a),
l.get_proof(d,b,this.f)):new Uint8Array(0)},m:function(a){var b=[];a.forEach(function(a,c){b.push(c,a[0])});b.push(this.a,this.a);return b},check_state_proof:function(a,b,c){return 0===b[0]&&l.check_proof(a,b,c,this.f)?b.subarray(1,this.l+1):null},i:function(a){var b=this.m(a);this.g=[l.get_root(b,this.f),a]}};Object.defineProperty(k.prototype,"constructor",{value:k});return k}"function"===typeof define&&define.amd?define(["array-map-set","k-bucket-sync","merkle-tree-binary"],u):"object"===typeof exports?
module.exports=u(require("array-map-set"),require("k-bucket-sync"),require("merkle-tree-binary")):this.es_dht=u(this.array_map_set,this.k_bucket_sync,this.merkle_tree_binary)}).call(this);